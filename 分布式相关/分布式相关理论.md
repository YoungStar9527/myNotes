# 1 分布式CAP理论

## 1.1 CAP简介

​	CAP定理又称CAP原则，值的是在一个分布式系统中，Consistency(一致性)、Availability(可用性)、Partition tolerance(分区容错性),最多只能同事三个特性得两个，三者不可兼得。

**PS:其实就是CP、AP直接作取舍，分布式系统本身就是P，不要求P(不允许分区)，意味着放弃了系统的扩展性，没法部署子节点，违背了分布式设计的理念。**

**Consistency(一致性):**

​	更新操作成功后，所有节点在同一时间的数据完全一致。

​	对客户端来说，一致性指的是并发访问时更新过的数据如何获取的问题。

​	从服务端来看，则是更新如何复制分布到整个系统，以保证数据最终一致。

**Availability(可用性)：**

​	即服务一致可用，而且是正常响应时间。

​	好的可用性可以很好的为用户服务，不出现用户操作失败或者超时等用户体验不好的情况。

**Partition Tolerance(分区容错性)**

​	即分布式系统在遇到某节点活网络故障的时候，仍然能够对外提供一致性或可用性的服务。

​	这里的分区是指网络分区，也可以理解为不同服务器直接的分区。

​	分区容错性要求能够使应用虽然是分布式系统，看上去却是一个可以正常运作的整体。分布式系统某一个或者几个机器宕掉了，剩下的其他机器还能正常运转满足系统需求，对用户而言没有体验的影响。

## 1.2 为什么不能同时满足三个特性

有两台服务器N1 N2，一台放着应用A1、数据库D1，一台放着应用A2，数据库D2。

​	在满足一致性的时候，两台服务器N1 N2对应的应用、数据库数据是一样的

​	在满足可用性的时候，用户不管请求N1或者N2都会立即响应

​	在满足分区容错性的情况下，N1和N2有任何一方方剂，或者网络不通的时候，都不会影响N1和N2彼此之间的正常运作

**系统正常运作的数据更新流程：**

​	当用户通过应用A1更新N1的数据库D1的时候，通过分布式系统数据同步更新操作，N2服务器上的数据库D2也完成了更新，此时D1 D2的数据都是更新后的数据。

**N1和N2之间网络断开的情况：**

​	在满足P分区容错的情况，支持这种网络异常，能不能同时满足一致性和可用性呢？

​	在向N1发送更新请求的时候，数据更新就不能同步到N2了。如果有用户向N2发送数据读取请求，应用程序没办法立即返回最新的数据给用户。

​	**此时有两种选择：**

​		**1 牺牲数据一致性，响应旧的数据给用户**

​		**2 牺牲可用性，阻塞等待，直到网络连接回复，数据更新操作完成后，再给用户响应最新的数据DB1**

## 1.3 取舍策略

**CAP三个特性只能满足其中两个，那么取舍策略共有三种：**

​	CA:这个是伪命题，如果不要求P（不允许分区），则C（强一致性）和A（可用性）是可以保证的。但放弃P的同时也就意味着放弃了系统的扩展性，也就是分布式节点受限，没办法部署子节点，这是违背分布式系统设计的初衷的。

​	CP:如果不要求A（可用），相当于每个请求都需要在服务器直接保持一致性，而分区P会导致同步时间的效率问题(也就是等待数据同步完才能正常访问服务)，一旦网络故障或者数据丢失的情况，就需要牺牲用户体验，等待所有数据一致了之后再运行访问系统。

**PS:一般来说只有银行，金融，涉及到钱的系统才会要求强一致性**

​	AP:不要求C(一致性)。在分区的情况下，节点直接可能失去联系，为了高可用，每个节点只能用本地数据提供服务，这样会导致全局的数据不一致性。最典型的场景就是抢购手机场景，购买前还有库存，下单的时候系统才会提示下单失败，商品已售完。

**总结：**

​	对于大型互联网系统来说，分区容错性是分布式系统比如面对的问题。只能在C和A进行取舍。

​	没有最好的策略，只有最适合的，好的系统就应该根据对应的业务场景来进行架构设计。

引用：https://blog.csdn.net/yeyazhishang/article/details/80758354

# 2 常见分布式问题

幂等性等

https://www.cnblogs.com/jackson0714/p/fenbushi.html